# HoneySens Service Registry
## Purpose
The HoneySens server utilizes a docker registry to serve images 
of honeypot services to its sensors. For that we use the regular
docker registry v2 and set it up within a container next to the
main honeysens one. Both are meant to be deployed within a
user-defined network [1] to that they can reference each other via
the integrated docker DNS service. 

## Architecture
The registry service is not open to the public, but instead only
accessible via the HoneySens container, which has a reverse proxy
configured for all registry URLs (currently `/v2/...`). Because of
that configuration, the registry itself is set up using plain HTTP 
instead of HTTPS. This allows easy access to the service from the 
HoneySens server itself. For public access, the reverse proxy 
guarantees access only via TLS and just for authenticated clients 
(client-cert check). It is also necessary to restrict clients (sensors) 
to just downloading service images. Other operations are forbidden
by restricting the available HTTP operations.

The docker client on the sensors requires special configuration to
trust the server certificate [2]. That certificate has to be a CA
certificate, which means that self-signed snakeoil certs that are
generated by some distributions (e.g. Debian) can't be used. Instead,
the HoneySens server has to provide self-signed CA certificates in
case the user didn't supply his own ones.

## Maintenance
The registry supports the deletion of tags and there are also a couple
of assisting tools (e.g. docker-registry-client [3], which doesn't support
deletion on V2 registries or docker-registry-util [5], which does) for such tasks.
However, deleted stuff (blobs/tags/manifests) are only marked as deleted
and have to be garbage collected later. The registry supports garbage
collection since version 2.4.0, but this process has to be triggered
manually [4]. Since our registry is running next to the docker container,
we have to schedule that task on the host system and therefore
include instructions for cron job creation into the admin manual.

So far, tools like docker-registry-util just delete tags, but leave empty
repositories. This shouldn't pose a problem, but might be nice to fix
at some point in the future.

[1] https://docs.docker.com/engine/userguide/networking/#user-defined-networks\
[2] https://docs.docker.com/registry/insecure/#using-self-signed-certificates\
[3] https://github.com/yodle/docker-registry-client\
[4] https://docs.docker.com/registry/garbage-collection/\
[5] https://github.com/merll/docker-registry-util